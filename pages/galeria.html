<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Galeria Pessoal - PhotoVerse</title>
    <link rel="stylesheet" href="../styles/estilos.css" />
    <style>
      /* pequenas regras locais para a demo */
      .hidden{display:none}
      #gallery{display:flex;flex-wrap:wrap;gap:10px}
      .photo{width:200px; border:1px solid #ddd; padding:6px}
      .photo img{width:100%; height:140px; object-fit:cover}
    </style>
  </head>
  <body>
    <main>
      <h1>Galeria Pessoal</h1>

      <!-- Autenticação automática (anônima) — sem UI para o usuário -->
      <section id="auth-section" class="hidden">
        <p id="user-info">Conectando...</p>
      </section>

      <section id="upload-section" class="hidden">
        <h3>Enviar Fotos</h3>
        <input id="file-input" type="file" accept="image/*" multiple />
        <button id="btn-upload">Enviar</button>
        <div id="upload-status"></div>
      </section>

      <section>
        <h3>Suas Fotos</h3>
        <div id="gallery"></div>
      </section>
    </main>

    <script>
      // Armazenamento local via IndexedDB — as imagens ficam apenas no navegador do usuário
      (function () {
        const dbName = 'photoverse-local';
        const storeName = 'photos';

        const gallery = document.getElementById('gallery');
        const fileInput = document.getElementById('file-input');
        const btnUpload = document.getElementById('btn-upload');
        const uploadStatus = document.getElementById('upload-status');

        function openDB() {
          return new Promise((resolve, reject) => {
            const req = indexedDB.open(dbName, 1);
            req.onupgradeneeded = (e) => {
              const db = e.target.result;
              if (!db.objectStoreNames.contains(storeName)) {
                db.createObjectStore(storeName, { keyPath: 'id', autoIncrement: true });
              }
            };
            req.onsuccess = (e) => resolve(e.target.result);
            req.onerror = (e) => reject(e.target.error);
          });
        }

        async function addPhoto(name, blob) {
          const db = await openDB();
          return new Promise((resolve, reject) => {
            const tx = db.transaction(storeName, 'readwrite');
            const store = tx.objectStore(storeName);
            const item = { name, blob, createdAt: Date.now() };
            const req = store.add(item);
            req.onsuccess = () => {
              tx.oncomplete = () => { db.close(); resolve(); };
            };
            req.onerror = (e) => reject(e.target.error);
          });
        }

        async function getAllPhotos() {
          const db = await openDB();
          return new Promise((resolve, reject) => {
            const tx = db.transaction(storeName, 'readonly');
            const store = tx.objectStore(storeName);
            const req = store.getAll();
            req.onsuccess = () => { resolve(req.result); db.close(); };
            req.onerror = (e) => reject(e.target.error);
          });
        }

        async function deletePhoto(id) {
          const db = await openDB();
          return new Promise((resolve, reject) => {
            const tx = db.transaction(storeName, 'readwrite');
            const store = tx.objectStore(storeName);
            const req = store.delete(id);
            req.onsuccess = () => { tx.oncomplete = () => { db.close(); resolve(); }; };
            req.onerror = (e) => reject(e.target.error);
          });
        }

        async function refreshGallery() {
          gallery.innerHTML = '';
          try {
            const photos = await getAllPhotos();
            photos.sort((a, b) => b.createdAt - a.createdAt);
            photos.forEach(p => {
              const el = document.createElement('div');
              el.className = 'photo';
              const img = document.createElement('img');
              const url = URL.createObjectURL(p.blob);
              img.src = url;
              img.alt = p.name;
              const info = document.createElement('div');
              info.textContent = p.name;
              const del = document.createElement('button');
              del.textContent = 'Excluir';
              del.addEventListener('click', async () => {
                if (confirm('Excluir esta foto?')) {
                  await deletePhoto(p.id);
                  refreshGallery();
                }
              });
              el.appendChild(img);
              el.appendChild(info);
              el.appendChild(del);
              gallery.appendChild(el);
            });
          } catch (err) {
            console.error('Erro ao ler fotos locais', err);
          }
        }

        btnUpload.addEventListener('click', async () => {
          const files = fileInput.files;
          if (!files || !files.length) { alert('Selecione ao menos uma imagem.'); return; }
          uploadStatus.textContent = 'Salvando localmente...';
          for (let i = 0; i < files.length; i++) {
            const file = files[i];
            // o File é um Blob e pode ser armazenado diretamente no IndexedDB
            try {
              await addPhoto(file.name, file);
            } catch (err) {
              console.error('Erro ao salvar localmente', err);
              alert('Erro ao salvar ' + file.name + ': ' + err.message);
            }
          }
          uploadStatus.textContent = 'Concluído.';
          fileInput.value = '';
          await refreshGallery();
        });

        // inicializa a galeria local
        window.addEventListener('load', () => { refreshGallery(); });
      })();
    </script>
  </body>
</html>
