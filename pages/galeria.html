<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Galeria Pessoal - PhotoVerse</title>
    <link rel="stylesheet" href="../styles/estilos.css" />
    <style>
      /* pequenas regras locais para a demo */
      .hidden{display:none}
      #gallery{display:flex;flex-wrap:wrap;gap:10px}
      .photo{width:200px; border:1px solid #ddd; padding:6px}
      .photo img{width:100%; height:140px; object-fit:cover}
    </style>
  </head>
  <body>
    <main>
      <h1>Galeria Pessoal</h1>

      <!-- Autenticação automática (anônima) — sem UI para o usuário -->
      <section id="auth-section" class="hidden">
        <p id="user-info">Conectando...</p>
      </section>

      <section id="upload-section" class="hidden">
        <h3>Enviar Fotos</h3>
        <input id="file-input" type="file" accept="image/*" multiple />
        <button id="btn-upload">Enviar</button>
        <div id="upload-status"></div>
      </section>

      <section>
        <h3>Suas Fotos</h3>
        <div id="gallery"></div>
      </section>
    </main>

    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
      import {
        getAuth,
        onAuthStateChanged,
        signInAnonymously
      } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';
      import {
        getFirestore,
        collection,
        addDoc,
        query,
        where,
        orderBy,
        onSnapshot,
        serverTimestamp
      } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';
      import {
        getStorage,
        ref,
        uploadBytes,
        getDownloadURL
      } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js';
      import { firebaseConfig } from './firebase-config.js';

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const storage = getStorage(app);

      // elementos
      const authSection = document.getElementById('auth-section');
      const userInfo = document.getElementById('user-info');
      const uploadSection = document.getElementById('upload-section');
      const fileInput = document.getElementById('file-input');
      const btnUpload = document.getElementById('btn-upload');
      const uploadStatus = document.getElementById('upload-status');
      const gallery = document.getElementById('gallery');

      let unsubscribeGallery = null;

      // Efetua login anônimo automaticamente para obter uid (sem UI)
      async function ensureAnonymousAuth() {
        try {
          if (!auth.currentUser) {
            await signInAnonymously(auth);
          }
        } catch (err) {
          console.error('Erro ao autenticar anonimamente', err);
          userInfo.textContent = 'Erro ao conectar: ' + err.message;
          authSection.classList.remove('hidden');
          uploadSection.classList.add('hidden');
        }
      }

      onAuthStateChanged(auth, user => {
        if (user) {
          authSection.classList.add('hidden');
          uploadSection.classList.remove('hidden');
          startGalleryListener(user.uid);
        } else {
          authSection.classList.remove('hidden');
          uploadSection.classList.add('hidden');
          if (unsubscribeGallery) { unsubscribeGallery(); unsubscribeGallery = null; }
        }
      });

      // inicia auth anônimo na carga da página
      ensureAnonymousAuth();

      function startGalleryListener(uid) {
        if (unsubscribeGallery) unsubscribeGallery();
        const photosCol = collection(db, 'photos');
        const q = query(photosCol, where('uid', '==', uid), orderBy('createdAt', 'desc'));
        unsubscribeGallery = onSnapshot(q, snapshot => {
          gallery.innerHTML = '';
          snapshot.forEach(doc => {
            const data = doc.data();
            const el = document.createElement('div');
            el.className = 'photo';
            el.innerHTML = `
              <img src="${data.url}" alt="${data.name}" />
              <div>${data.name}</div>
            `;
            gallery.appendChild(el);
          });
        }, err => {
          console.error('Erro ao carregar galeria', err);
        });
      }

      btnUpload.addEventListener('click', async () => {
        const user = auth.currentUser;
        if (!user) { alert('Aguarde, conectando...'); return; }
        const files = fileInput.files;
        if (!files.length) { alert('Selecione ao menos uma imagem.'); return; }

        uploadStatus.textContent = 'Enviando...';
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const path = `users/${user.uid}/${Date.now()}_${file.name}`;
          const storageRef = ref(storage, path);
          try {
            await uploadBytes(storageRef, file);
            const url = await getDownloadURL(storageRef);
            await addDoc(collection(db, 'photos'), {
              uid: user.uid,
              url,
              name: file.name,
              createdAt: serverTimestamp()
            });
          } catch (err) {
            console.error('Erro no upload', err);
            alert('Erro ao enviar ' + file.name + ': ' + err.message);
          }
        }
        uploadStatus.textContent = 'Upload concluído.';
        fileInput.value = '';
      });

    </script>
  </body>
</html>
